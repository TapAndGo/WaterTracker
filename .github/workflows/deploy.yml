name: Build, Push, and Update Watertracker Deployment

on:
  push:
    branches:
      - main
      - developer
      - feature/*

jobs:
  build-push-update:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Watertracker Repo
      - name: Checkout Watertracker Repo
        uses: actions/checkout@v4

      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3: Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      # Step 4: Build Docker images
      - name: Build Watertracker Image
        id: build_image
        run: |
          BRANCH=$(echo "${GITHUB_REF##*/}" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
          SHA=$(git rev-parse --short HEAD)

          if [ "$BRANCH" = "main" ]; then
            IMAGE_BASE="${{ secrets.DOCKER_USERNAME }}/watertracker-prod"
            IMAGE_TAG="prod"
          else
            IMAGE_BASE="${{ secrets.DOCKER_USERNAME }}/watertracker-staging"
            IMAGE_TAG="dev"
          fi

          echo "image_base=$IMAGE_BASE" >> $GITHUB_OUTPUT
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "sha_tag=$SHA" >> $GITHUB_OUTPUT

          echo "Building images..."
          docker build -t "$IMAGE_BASE:$IMAGE_TAG" .
          docker tag "$IMAGE_BASE:$IMAGE_TAG" "$IMAGE_BASE:$SHA"

      # Step 5: Push Docker images
      - name: Push Watertracker Images
        run: |
          IMAGE_BASE=${{ steps.build_image.outputs.image_base }}
          IMAGE_TAG=${{ steps.build_image.outputs.image_tag }}
          SHA_TAG=${{ steps.build_image.outputs.sha_tag }}

          echo "Pushing $IMAGE_BASE:$IMAGE_TAG"
          docker push "$IMAGE_BASE:$IMAGE_TAG"

          echo "Pushing $IMAGE_BASE:$SHA_TAG"
          docker push "$IMAGE_BASE:$SHA_TAG"

      # Step 6: Checkout InfraOps repo
      - name: Checkout InfraOps Repo
        uses: actions/checkout@v4
        with:
          repository: your-org/infraops
          token: ${{ secrets.GH_TOKEN }}
          ref: main
          path: infraops

      # Step 7: Install yq for YAML editing
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq \
            https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version

      # Step 8: Compute deployment file path
      - name: Compute deployment file path
        id: target
        run: |
          BRANCH="${GITHUB_REF_NAME#refs/heads/}"
          if [ "$BRANCH" = "main" ]; then
            FILE="infraops/services/watertracker/deployment.yaml"
          else
            FILE="infraops/qaservices/watertracker/deployment.yaml"
          fi
          echo "file=$FILE" >> "$GITHUB_OUTPUT"
          echo "Deployment file: $FILE"

      # Step 9: Update deployment.yaml
      - name: Update deployment.yaml
        run: |
          FILE="${{ steps.target.outputs.file }}"
          IMAGE="${{ steps.build_image.outputs.image_base }}:${{ steps.build_image.outputs.sha_tag }}"
          echo "Updating $FILE with image: $IMAGE"
          if [ ! -f "$FILE" ]; then
            echo "ERROR: $FILE does not exist!"
            ls -la "$(dirname $FILE)"
            exit 1
          fi
          echo "Old image:"
          yq eval '.spec.template.spec.containers[0].image' "$FILE"
          yq eval ".spec.template.spec.containers[0].image = \"$IMAGE\"" -i "$FILE"
          echo "New image:"
          yq eval '.spec.template.spec.containers[0].image' "$FILE"

      # Step 10: Commit and push changes
      - name: Commit and push changes
        run: |
          cd infraops
          FILE="${{ steps.target.outputs.file }}"
          IMAGE="${{ steps.build_image.outputs.image_base }}:${{ steps.build_image.outputs.sha_tag }}"

          git config user.name "CI Bot from GitHub Actions"
          git config user.email "actions@github.com"
          
          git add "$FILE"
          git commit -m "chore: update watertracker image to $IMAGE (${{ github.ref_name }})" || echo "No changes to commit"
          git push origin main
